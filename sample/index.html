<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Leaflet Layer Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <script src="../dist/leaflet-layer-manager.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        #layers,
        #add,
        #sort {
            display: block;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #map {
            width: 600px;
            height: 600px
        }

        .main {
            display: table;
            width: 100%;
        }

        .map {
            display: table-cell;
            vertical-align: top;
            width: 620px;
        }

        .controllers {
            display: table-cell;
            vertical-align: top;
        }

        .order-item {
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 5px;
            background-color: ghostwhite;
            cursor: grab;
        }
    </style>
</head>

<body>
    <div class="main">
        <div class="map">
            <div id="map"></div>
        </div>
        <div class="controllers">
            <form>
                <div id="baseLayers"></div>
                <div id="layers"></div>
            </form>
            <button id="add" type="button">add</button>

            <div id="sort">
                <button id="sort_index" type="button">sort by index</button>
                <button id="sort_name" type="button">sort by name</button>
            </div>
            <div>
                <div>重なり順</div>
                <div id="order"></div>
            </div>
        </div>
    </div>
</body>
<script>
    var map = L.map("map").setView([35.681236, 139.767125], 10);

    var baseLayers = [{
        name: "標準地図",
        layer: L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
            attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
        })
    }, {
        name: "OpenStratMap",
        layer: L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        })
    }];


    var layers = [{
            name: "test4",
            layer: L.imageOverlay('6.png', L.latLngBounds(
                [35.71083783530008, 139.7021484375],
                [35.63944106897394, 139.7900390625]
            )),
            params: {
                index: 1
            }
        },
        {
            name: "test3",
            layer: [{
                    name: "test3_3",
                    layer: L.imageOverlay('1.png', L.latLngBounds(
                        [35.67514743608467, 139.74609375],
                        [35.6037187406973, 139.833984375]
                    )),
                    params: {
                        index: 1
                    }
                }, {
                    name: "test3_2",
                    layer: L.imageOverlay('2.png', L.latLngBounds(
                        [35.67514743608467, 139.7900390625],
                        [35.6037187406973, 139.8779296875]
                    )),
                    params: {
                        index: 2
                    }
                },
                {
                    name: "test3_1",
                    layer: L.imageOverlay('3.png', L.latLngBounds(
                        [35.63944106897394, 139.7900390625],
                        [35.56798045801208, 139.8779296875]
                    )),
                    params: {
                        index: 3
                    }
                }
            ],
            params: {
                index: 2
            }
        },
        {
            name: "test2",
            layer: L.imageOverlay('4.png', L.latLngBounds(
                [35.67514743608467, 139.833984375],
                [35.6037187406973, 139.921875]
            )),
            params: {
                index: 3
            }
        }, {
            name: "test1",
            layer: L.imageOverlay('5.png', L.latLngBounds(
                [35.6037187406973, 139.74609375],
                [35.532226227703376, 139.833984375]
            )),
            params: {
                index: 4
            }
        }, {
            name: "色別標高図(tileLayer)",
            layer: L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png", {
                attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
            }),
            params: {
                index: 1001
            }
        }, {
            name: "航空写真(tileLayer)",
            layer: L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg", {
                attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
            }),
            params: {
                index: 1000
            }
        }
    ];

    var baseLyrs = [];
    for (var i = 0; i < baseLayers.length; i++) {
        baseLyrs.push(LeafletLayerManager.createLyr(baseLayers[i].name, baseLayers[i].layer,
            baseLayers[i].params));
    }
    var selectedBaseLyrName = baseLyrs[baseLyrs.length - 1].name;
    var lyrs = [];
    var showLyrNames = [];
    for (var i = 0; i < layers.length; i++) {
        lyrs.push(LeafletLayerManager.createLyr(layers[i].name,
            layers[i].layer, layers[i].params));
        if (layers[i].name.startsWith('test')) {
            showLyrNames.push(layers[i].name);
        }
    }


    var m = LeafletLayerManager.create(map, {
        "baseLyrs": baseLyrs,
        "lyrs": lyrs,
        "showLyrNames": showLyrNames,
        "selectedBaseLyrName": selectedBaseLyrName,
        "managerOptions": {
            "baseZIndex": 10
        }
    });


    function baseLayerController(name) {
        var baseLayerParent = document.getElementById("baseLayers");
        var div = document.createElement("div");
        var label = document.createElement("label");
        var input = document.createElement("input");
        input.value = name;
        input.name = "base";
        input.type = "radio";
        label.appendChild(input);
        label.innerHTML = label.innerHTML + name;
        div.appendChild(label);
        baseLayerParent.appendChild(div);

        var baseLayerInput = document.querySelector('input[name=base][value="' + name + '"]');
        baseLayerInput.checked = true
        baseLayerInput.addEventListener("click", function (e) {
            var input = document.querySelector("[name=base]:checked");
            m.selectBaseLyr(input.value);
        });

    }

    function layerController(name, show) {
        var layersParent = document.getElementById("layers");
        var div = document.createElement("div");
        var label = document.createElement("label");
        var input = document.createElement("input");
        var range = document.createElement("input");
        input.value = name;
        input.name = "layers";
        input.type = "checkbox";
        label.innerHTML = label.innerHTML + name;
        range.value = 100;
        range.dataset.layer = name;
        range.type = "range";

        if (show) {
            input.checked = true;
        }
        input.addEventListener("click", function (e) {
            var input = e.target;
            if (input.checked) {
                m.showLyr(input.value)
            } else {
                m.hideLyr(input.value)
            }
        });
        range.addEventListener("change", function (e) {
            m.setOpacity(e.target.dataset.layer, parseInt(e.target.value, 10) / 100);
        });

        range.addEventListener("click", function (e) {
            e.preventDefault();
        });

        label.appendChild(input);
        div.appendChild(label);
        div.appendChild(document.createElement("br"));
        div.appendChild(range);
        layersParent.appendChild(div);

        var orderParent = document.getElementById("order");
        var order = document.createElement("div");
        order.innerHTML = name;
        order.className = "order-item";
        orderParent.appendChild(order);
    }

    for (var i = 0; i < baseLayers.length; i++) {
        baseLayerController(baseLayers[i].name)
    }

    for (var i = 0; i < layers.length; i++) {
        layerController(layers[i].name, showLyrNames.indexOf(layers[i].name) > -1)
    }

    document.getElementById("sort_index").addEventListener("click", function (e) {
        m.sort(function (a, b) {
            return a.params.index - b.params.index;
        }, true)
    });
    document.getElementById("sort_name").addEventListener("click", function (e) {
        m.sort(undefined, true)
    });

    var newLayer = {
        name: "test5",
        layer: L.imageOverlay('6.png', L.latLngBounds(
            [35.7465122599185, 139.658203125],
            [35.6037187406973, 139.833984375]
        )),
        params: {
            index: 0
        }
    }
    var addedNewLayer = false;
    document.getElementById("add").addEventListener("click", function (e) {
        if (!addedNewLayer) {
            e.target.disabled = true;
            m.addLyr(LeafletLayerManager.createLyr(newLayer.name, newLayer.layer,
                newLayer.params));
            addedNewLayer = true;

            layerController(newLayer.name, true);
        }
    });


    Sortable.create(document.getElementById("order"), {
        onEnd: function (evt) {
            m.move(evt.oldIndex, evt.newIndex);
        }
    });
</script>

</html>